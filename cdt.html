<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width" >
<link rel="stylesheet" href="./jqm/jquery.mobile.css" />
<title>CountDownTimer</title>
<style>
body {
	margin: 300;
	padding: 0;
	text-align:center;
}
#inner {
	text-align:center;
	margin-left:auto;
	margin-right:auto;
	text-align:center;
	width: 280px;
	margin: 0;
}

#countdown {
	text-align:center;
	margin-left:auto;
	margin-right:auto;
	text-align:center;
	font-family: serif;
	font-weight: bold;
	width: 280px;
	color: #990000;
}
.day, .hou, .min, .sec, .mil {/*カウントする数字の大きさ*/
	font-size: 48px;
}
.day {
}
.hou {
}
.min {
}
.sec {
}
.mil {
}
.moji {/*日とか時間とか秒とかの文字の色と大きさ*/
	font-size: 36px;
	color:#000000;
}
</style>
<script type="text/javascript" src="./jquery.js"></script>
<script type="text/javascript" src="./jqm/jquery.mobile.js"></script>
</head>

<body>
<div id="header" style='text-align : left'><h1><b>CountDownTimer</b></h1></div>
<div style='border-radius:5px;border:1px solid lightblue;padding:10px;margin:2px 20px 5px 20px;text-align : center'>
<div id="titleElm" style='text-align : center'><h1>CountDownTimer</h1></div>
<div id="message" style='text-align : center'><h3></h3></div>
<div id="inner" style='text-align : center'>
  <div id="countdown" style='text-align : center;padding:5px'><h2></h2></div>
</div>
</div>
<div id="footer" style='text-align : right'>happyChappy（<a href="https://twitter.com/happyChappy1115" target="_blank">@happyChappy1115</a>）</div>
	
<script language="JavaScript" type="text/javascript">
var link=location.search.substr(1);
var inText=decodeURIComponent(link);
var destiny=inText.split('\n')[0];

var e=document.getElementById("titleElm");
//alert(e);
e.innerHTML='<b>'+destiny+'</b>';

var timeTable=inText.split('\n')[1];
//alert('destiny='+destiny+'\ntimeTable='+timeTable);
timeList=timeTable.split(' ');
for (var i=0;i<timeList.length-1;i++){
	if (timeList[i].split(':')[0]<10){
		timeList[i]='0'+timeList[i];
	}
}

function getNextTime(){
var jikan= new Date();
var year=jikan.getFullYear();
var month=jikan.getMonth()+1;
var days=jikan.getDate();
var hour = jikan.getHours();
if (hour<10){hour='0'+hour}
var minute = jikan.getMinutes();
if (minute<10){minute='0'+minute}
var second = jikan.getSeconds();
//alert(hour+'時'+minute+'分'+second+'秒');
var nowDate=year+'/'+month+'/'+days;
var nowTime=hour+':'+minute+':'+second;
endTime=nowDate+' '+timeList[timeList.length-1]+':00';
for (i=0;i<timeList.length-2;i++){
  //alert('now='+nowTime+'\ni='+timeList[i]+':00\ni+1='+timeList[i+1]+':00');
  if (nowTime>=timeList[i]+':00'){
	if (nowTime<timeList[i+1]+':00'){
		nextTime=nowDate+' '+timeList[i+1];
		num=i+1;
		if (i+2<=timeList.length-1){
		  nextNextTrain=timeList[i+2];
		} else {
		  nextNextTrain='';
		}
		break;
	} else if (nowTime>timeList[timeList.length-1]+':00'){
		nextTime=nowDate+' '+timeList[timeList.length-1];
		num=timeList.length-1;
		nextNextTrain='終了';
		break;
	}
  } else {
	  nextTime=nowDate+' '+timeList[0];
	  num=0;
	  nextNextTrain=timeList[1];
	  break;
  }
}
        //alert(endTime);
        nextTrain=nextTime.split(' ')[1];
        var mesElm=document.getElementById("message");
        mesElm.innerHTML="次→"+nextTrain+" その次→"+nextNextTrain;
	
	return nextTime+','+num;
}

//tt=getNextTime();
//trainTime=tt.split(',')[0]+':00';
//gnt=getNextTime();
//nt=gnt.split(',')[0];
//nextNextTrain=gnt.split(',')[1];
//nextTrain=nt.split(' ')[1];
</script>     

<script language="JavaScript" type="text/javascript">
//reLoad=false;
function CountdownTimer(elm,tl,mes){
 this.initialize.apply(this,arguments);
}
CountdownTimer.prototype={
 initialize:function(elm,tl,mes) {
  this.elem = document.getElementById(elm);
  this.tl = tl;
  this.mes = mes;
 },countDown:function(){
  var timer='';
  var today=new Date();
  var day=Math.floor((this.tl-today)/(24*60*60*1000));
  var hou=Math.floor(((this.tl-today)%(24*60*60*1000))/(60*60*1000));
  var min=Math.floor(((this.tl-today)%(24*60*60*1000))/(60*1000))%60;
  var sec=Math.floor(((this.tl-today)%(24*60*60*1000))/1000)%60%60;
  //var mil=Math.floor(((this.tl-today)%(24*60*60*1000))/10)%100;
  var me=this;
  if( ( this.tl - today ) > 0 ){
   //if (day) timer += '<span class="day">'+day+'</span><span class="moji">日</span>';
   if (hou) timer += '<span class="hou">'+hou+'</span><span class="moji">時間</span>';
   timer += '<span class="min">'+this.addZero(min)+'</span><span class="moji">分</span><span class="sec">'+this.addZero(sec)+'</span><span class="moji">秒</span>';
   this.elem.innerHTML = timer;
   tid = setTimeout( function(){me.countDown();},10 );
  }else if (endTime-today<0){
   this.elem.innerHTML = this.mes;
   return;
  } else if (this.tl-today==0){
     //nextTrainTime=getNextTime();
     //nowNum=nextTrainTime.split(',')[1];
     //if (nowNum=timeList.length-1){
	//this.tl=timeList[timeList.length-1]+':00';
     //} else {
        //this.tl=timeList[nowNum+1]+':00';
     //}
     //reLoad=true;
     tt=getNextTime();
     trainTime=tt.split(',')[0]+':00';
     tl = Date(trainTime);
     timer = CountdownTimer('countdown',tl,'本日分は終了しました');
     timer.countDown();
     //me.countdown();
     //window.onload=countdown();
     //window.location.reload();
  }
 },addZero:function(num){ return ('0'+num).slice(-2); }
}

function countdown(){
//nextTime=nextTime+':00';
//alert(nextTime);
 tt=getNextTime();
 //if (tt>trainTime){
   trainTime=tt.split(',')[0]+':00';
 //}
 //alert(trainTime);
 var tl = new Date(trainTime);
 //この上の部分で終了時間を設定するYO！
 //window.location.reload();
 var timer = new CountdownTimer('countdown',tl,'本日分は終了しました');
 //この上の文は終了した後に表示する文字!
//if (reLoad){
  //window.location.reload();
//}
//reLoad=false;
timer.countDown();
}
//nextTrainTime=getNextTime();
window.onload=function(){
 countdown();
}
//window.onload=countdown();
</script>
</body>
</html>
